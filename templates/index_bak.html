<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‚®ä»¶æ‰“æ ‡å·¥å…· - Email Tagging Tool</title>

    <!-- JSON Editor CSS -->
    <link href="https://unpkg.com/jsoneditor@latest/dist/jsoneditor.min.css" rel="stylesheet" type="text/css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .main-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        .panel {
            padding: 10px;
            overflow: auto;
            box-sizing: border-box;
        }

        #left-panel {
            flex: 0 0 50%;
            width: 50%;
            background-color: #f8f9fa;
            border-right: 2px solid #dee2e6;
            position: relative;
        }

        #right-panel {
            flex: 0 0 50%;
            width: 50%;
            display: flex;
            flex-direction: column;
        }


        #response-panel {
            height: 60px;
            background-color: #f9f9f9;
            border-bottom: 2px solid #dee2e6;
            position: relative;
            transition: height 0.3s ease;
            overflow: hidden;
        }

        #response-panel.expanded {
            height: 50%;
        }

        #expect-panel {
            flex: 1;
            background-color: #f5f5f5;
            position: relative;
        }

        #expect-panel.collapsed {
            height: calc(100% - 60px);
        }

        /* JSONç¼–è¾‘å™¨å®¹å™¨ */
        .json-editor-container {
            height: calc(100% - 100px);
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        /* å½“API Responseé¢æ¿æ”¶èµ·æ—¶ï¼Œéšè—ç¼–è¾‘å™¨ */
        #response-panel:not(.expanded) .json-editor-container {
            display: none;
        }

        /* åªåœ¨JSONç¼–è¾‘å™¨ä¸­éšè—å›¾ç‰‡ï¼ŒHTMLå†…å®¹ä¸­æ­£å¸¸æ˜¾ç¤º */
        .json-editor-container img {
            display: none !important;
        }



        .json-editor {
            height: 100%;
            width: 100%;
        }

        /* é¢æ¿æ ‡é¢˜ä¼˜åŒ– */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: #495057;
            margin: 0;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .quick-btn {
            padding: 5px 12px;
            font-size: 12px;
            border: 1px solid #6c757d;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background-color: #f8f9fa;
        }

        .quick-btn.primary {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .quick-btn.primary:hover {
            background-color: #0056b3;
        }

        .quick-btn.warning {
            background-color: #ffc107;
            color: #000;
        }

        .quick-btn.warning:hover {
            background-color: #e0a800;
        }

        pre {
            width: 100%;
            height: 70%;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            overflow: auto;
            font-size: 13px;
            line-height: 1.4;
        }

        .request-item {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            margin: 2px 8px;
            border-radius: 6px;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .request-item:hover {
            background-color: #e3f2fd;
            transform: translateX(2px);
        }

        .request-item.active {
            background-color: #1976d2;
            color: white;
            box-shadow: 0 3px 6px rgba(25, 118, 210, 0.3);
        }

        .request-item.active .request-number {
            color: #bbdefb;
        }

        .request-item.tagged {
            border-left: 4px solid #4caf50;
        }

        .request-item.tagged::after {
            content: "âœ“";
            position: absolute;
            right: 8px;
            top: 8px;
            color: #4caf50;
            font-weight: bold;
        }

        /* è¯·æ±‚é¡¹å†…å®¹å¸ƒå±€ */
        .request-item {
            display: flex;
            align-items: center;
            position: relative;
        }

        .request-item-content {
            flex: 1;
        }

        /* æœ‰ä¿®æ”¹æŒ‰é’®æ ·å¼ */
        .modification-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
            white-space: nowrap;
            z-index: 10;
        }

        .modification-btn:hover {
            background: linear-gradient(135deg, #f57c00, #e65100);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.4);
        }

        .modification-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
        }

        /* æ™ºèƒ½diffæ ·å¼ */
        .smart-diff-container {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            max-height: 500px;
            overflow-y: auto;
        }

        .diff-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid transparent;
        }

        .diff-item.added {
            background-color: #d4edda;
            border-left-color: #28a745;
        }

        .diff-item.removed {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }

        .diff-item.unchanged {
            background-color: #f1f3f4;
            border-left-color: #6c757d;
            opacity: 0.7;
        }

        .diff-path {
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .diff-content {
            white-space: pre-wrap;
            word-break: break-all;
        }

        .diff-item.added .diff-content {
            color: #155724;
        }

        .diff-item.removed .diff-content {
            color: #721c24;
        }

        .json-content {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .button-container {
            margin: 10px 0;
        }

        button {
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
        }

        .status-success {
            color: green;
        }

        .status-error {
            color: red;
        }

        .refresh-btn {
            margin-left: 10px;
        }


        .debug-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .html-count {
            background-color: #2196F3;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 8px;
            font-weight: 500;
        }

        .request-number {
            display: inline-block;
            width: 40px;
            text-align: right;
            margin-right: 10px;
            font-weight: bold;
            color: #666;
        }

        .sort-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            padding-left: 5px;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .notification.error {
            background-color: #f44336;
        }

        /* å¼¹å‡ºå±‚æ ·å¼ - åªè¦†ç›–å·¦ä¾§é¢æ¿ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 50%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 8px;
            width: 95%;
            max-height: 90%;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background-color: #f0f0f0;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
            background-color: #e0e0e0;
            border-radius: 50%;
        }

        .modal-body {
            padding: 20px;
            overflow: auto;
            max-height: calc(90vh - 120px);
        }

        .modal-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .modal-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #666;
        }

        .modal-tab.active {
            color: #0066cc;
            border-bottom-color: #0066cc;
        }

        .modal-tab:hover {
            background-color: #f5f5f5;
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        /* å¼¹å‡ºå±‚ä¸­çš„é“¾æ¥å’Œå›¾ç‰‡æ ·å¼ */
        .popup-link {
            color: #007bff !important;
            text-decoration: underline !important;
            cursor: pointer !important;
            transition: opacity 0.2s ease;
        }

        .popup-link:hover {
            opacity: 0.8;
            text-decoration: underline !important;
        }

        .popup-image {
            cursor: help;
            transition: opacity 0.2s ease;
            border: 1px solid transparent;
        }

        .popup-image:hover {
            opacity: 0.9;
            border: 1px solid #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }

        .popup-bg-image {
            cursor: help;
            position: relative;
        }

        .popup-bg-image:hover {
            opacity: 0.9;
        }

        /* å¼¹å‡ºå±‚å†…å®¹åŒºåŸŸçš„æ ·å¼ä¼˜åŒ– */
        .modal-body a {
            color: #007bff !important;
            text-decoration: underline !important;
        }

        .modal-body a:hover {
            color: #0056b3 !important;
            opacity: 0.8;
        }

        .modal-body img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .modal-body img:hover {
            opacity: 0.9;
            box-shadow: 0 2px 8px rgba(0,123,255,0.2);
        }

        /* JSONç¼–è¾‘å™¨ä¸­é‡è¦å­—æ®µçš„é«˜äº®æ ·å¼ */
        .jsoneditor-field.important-field,
        .jsoneditor-value.important-value {
            color: #dc3545 !important;
            font-weight: bold !important;
        }

        .jsoneditor-field.important-field {
            background-color: rgba(220, 53, 69, 0.1) !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            position: relative;
        }

        /* å¯ç‚¹å‡»URLå­—æ®µæ ·å¼ */
        .jsoneditor-value.clickable-url {
            color: #007bff !important;
            text-decoration: underline !important;
            cursor: pointer !important;
            transition: color 0.2s ease;
        }

        .jsoneditor-value.clickable-url:hover {
            color: #0056b3 !important;
            background-color: rgba(0, 123, 255, 0.1) !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
        }

        .jsoneditor-field.url-field {
            color: #007bff !important;
            font-weight: 500 !important;
        }

        /* æ–‡æœ¬é€‰æ‹©é«˜äº®åŠŸèƒ½æ ·å¼ */
        .json-search-highlight {
            background-color: #ffeb3b !important;
            color: #000 !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            box-shadow: 0 0 8px rgba(255, 235, 59, 0.6) !important;
            animation: highlightPulse 1s ease-in-out;
        }

        @keyframes highlightPulse {
            0% {
                background-color: #ffeb3b;
                transform: scale(1);
            }
            50% {
                background-color: #ffc107;
                transform: scale(1.05);
            }
            100% {
                background-color: #ffeb3b;
                transform: scale(1);
            }
        }

        /* æœç´¢ç»“æœæç¤ºæ¡†é®ç½©å±‚ */
        .search-toast-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 15000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeInOverlay 0.3s ease;
        }

        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* æœç´¢ç»“æœæç¤ºæ¡† */
        .search-result-toast {
            background: white;
            color: #333;
            padding: 24px 32px;
            border-radius: 12px;
            font-size: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            min-width: 320px;
            text-align: center;
            transform: scale(0.8);
            animation: toastPopIn 0.3s ease forwards;
            border: 2px solid transparent;
        }

        @keyframes toastPopIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .search-result-toast.success {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
        }

        .search-result-toast.error {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
        }

        .search-result-toast strong {
            font-size: 18px;
            display: block;
            margin-bottom: 8px;
        }

        .search-result-toast .search-details {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 8px;
        }

        /* è‡ªå®šä¹‰å³é”®èœå•æ ·å¼ */
        .custom-context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 200px;
            padding: 4px 0;
            font-size: 14px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        .context-menu-item .icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        .context-menu-separator {
            height: 1px;
            background-color: #e0e0e0;
            margin: 4px 0;
        }

        .url-preview {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 4px 16px;
            background-color: #f8f9fa;
        }

        /* é€šç”¨çš„é‡è¦å­—æ®µæ ·å¼ */
        .jsoneditor .jsoneditor-tree .jsoneditor-field {
            position: relative;
        }

        .important-field {
            color: #dc3545 !important;
            font-weight: bold !important;
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, transparent 100%) !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            border-left: 3px solid #dc3545 !important;
        }

        .important-field::before {
            content: "";
        }

        /* ç‰¹åˆ«ä¸ºshop_domainå­—æ®µæ·»åŠ æ›´æ˜æ˜¾çš„æ ·å¼ */
        .jsoneditor-field.important-field {
            position: relative;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                background-color: rgba(220, 53, 69, 0.1);
                box-shadow: 0 0 5px rgba(220, 53, 69, 0.3);
            }
            to {
                background-color: rgba(220, 53, 69, 0.2);
                box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
            }
        }

        /* å¼¹å‡ºå±‚çŠ¶æ€æ  */
        .modal-status-bar {
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            padding: 8px 16px;
            font-size: 12px;
            color: #6c757d;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            min-height: 32px;
            display: flex;
            align-items: center;
        }

        #modal-url-display {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Diffå¯¹æ¯”å¼¹å‡ºå±‚æ ·å¼ */
        .diff-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .diff-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 8px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .diff-header {
            background-color: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diff-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            color: #495057;
        }

        .diff-close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .diff-close:hover {
            color: #333;
            background-color: #e0e0e0;
            border-radius: 50%;
        }

        .diff-body {
            display: flex;
            height: calc(90vh - 120px);
        }

        .diff-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #dee2e6;
        }

        .diff-panel:last-child {
            border-right: none;
        }

        .diff-panel-header {
            background-color: #f1f3f4;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            text-align: center;
        }

        .diff-panel-content {
            flex: 1;
            padding: 15px;
            overflow: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .diff-added {
            background-color: #d4edda;
            color: #155724;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .diff-removed {
            background-color: #f8d7da;
            color: #721c24;
            padding: 2px 4px;
            border-radius: 3px;
            text-decoration: line-through;
        }

        .diff-modified {
            background-color: #fff3cd;
            color: #856404;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .diff-actions {
            padding: 15px 20px;
            border-top: 2px solid #dee2e6;
            background-color: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diff-info {
            font-size: 14px;
            color: #6c757d;
        }

        .diff-buttons {
            display: flex;
            gap: 10px;
        }

        .diff-btn {
            padding: 8px 16px;
            border: 1px solid #6c757d;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .diff-btn:hover {
            background-color: #f8f9fa;
        }

        .diff-btn.primary {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        .diff-btn.primary:hover {
            background-color: #218838;
        }

        .diff-btn.secondary {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .diff-btn.secondary:hover {
            background-color: #545b62;
        }
    </style>
</head>

<body>
    <div class="main-container">
    <div id="left-panel" class="panel">
            <div class="panel-header">
                <h3 class="panel-title">ğŸ“§ å¾…æ‰“æ ‡é‚®ä»¶åˆ—è¡¨</h3>
                <div class="panel-actions">
                    <button id="refresh-btn" class="quick-btn">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>
        <div id="requests-list"></div>
    </div>

    <div id="right-panel" class="panel">
        <div id="response-panel" class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">ğŸ¤– ç®—æ³•è¾“å‡ºç»“æœ (API Response)</h3>
                    <div class="panel-actions">
                        <button class="quick-btn" id="toggle-response-btn">ğŸ‘ï¸ å±•å¼€</button>
                        <button class="quick-btn" id="copy-response-btn">ğŸ“‹ å¤åˆ¶</button>
                        <button class="quick-btn" id="format-response-btn">ğŸ¨ æ ¼å¼åŒ–</button>
                    </div>
                </div>
                <div class="json-editor-container">
                    <div id="response-editor" class="json-editor"></div>
                </div>
        </div>
        <div id="expect-panel" class="panel">
                <div class="panel-header">
                    <h3 class="panel-title">âœ… äººå·¥æ ‡æ³¨ç»“æœ (Expected Response) <small style="color: #6c757d; font-weight: normal;">âŒ¨ï¸ Ctrl+Sä¿å­˜ | Ctrl+Shift+Så¼ºåˆ¶ä¿å­˜</small></h3>
                    <div class="panel-actions">
                        <button class="quick-btn" id="copy-from-response">ğŸ“¥ ä»ä¸Šæ–¹å¤åˆ¶</button>
                        <button class="quick-btn warning" id="reset-expect-btn">ğŸ—‘ï¸ åˆ é™¤æ ‡æ³¨æ¢å¤æœªæ ‡æ³¨çŠ¶æ€</button>
                        <button class="quick-btn primary" id="save-btn">ğŸ’¾ ä¿å­˜æ ‡æ³¨</button>
                        <button class="quick-btn" id="reset-btn">ğŸ”„ é‡ç½®</button>
                    </div>
                </div>
                <div class="json-editor-container">
                    <div id="expect-editor" class="json-editor"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥æç¤ºæ¡† -->
    <div id="notification" class="notification"></div>



    <!-- HTMLå†…å®¹å¼¹å‡ºå±‚ -->
    <div id="htmlModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">HTML Content</h3>
                <button class="modal-close" id="modalCloseBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-tabs" id="modalTabs">
                    <!-- HTMLæ–‡ä»¶é€‰é¡¹å¡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div id="modalTabsContent">
                    <!-- HTMLå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            <div class="modal-status-bar" id="modal-status-bar">
                <span id="modal-url-display">ğŸ” é¼ æ ‡æ‚¬åœåœ¨é“¾æ¥æˆ–å›¾ç‰‡ä¸ŠæŸ¥çœ‹å®Œæ•´URL | ğŸ’¡ é€‰ä¸­æ–‡æœ¬è‡ªåŠ¨åœ¨JSONä¸­æœç´¢(å¿½ç•¥å¤§å°å†™) | ğŸ–±ï¸ å³é”®URLæ‰“å¼€èœå• | âŒ¨ï¸ Ctrl+Sä¿å­˜ Ctrl+Shift+Så¼ºåˆ¶ä¿å­˜</span>
            </div>
        </div>
    </div>

    <!-- Diffå¯¹æ¯”å¼¹å‡ºå±‚ -->
    <div id="diffModal" class="diff-modal">
        <div class="diff-modal-content">
            <div class="diff-header">
                <h3 class="diff-title">ğŸ” æ ‡æ³¨å¯¹æ¯”ç¡®è®¤</h3>
                <button class="diff-close" id="diffCloseBtn">&times;</button>
            </div>
            <div class="diff-body">
                <div class="diff-panel">
                    <div class="diff-panel-header">ğŸ¤– ç®—æ³•è¾“å‡ºç»“æœ</div>
                    <div class="diff-panel-content" id="diffOriginal"></div>
                </div>
                <div class="diff-panel">
                    <div class="diff-panel-header">âœ… äººå·¥æ ‡æ³¨ç»“æœ</div>
                    <div class="diff-panel-content" id="diffModified"></div>
                </div>
            </div>
            <div class="diff-actions">
                <div class="diff-info">
                    <span id="diffStats">æ£€æµ‹åˆ° 0 å¤„ä¿®æ”¹</span>
                </div>
                <div class="diff-buttons">
                    <button class="diff-btn secondary" id="diffCancelBtn">å–æ¶ˆ</button>
                    <button class="diff-btn primary" id="diffConfirmBtn">ç¡®è®¤ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å³é”®èœå• -->
    <div id="customContextMenu" class="custom-context-menu">
        <div class="url-preview" id="contextMenuUrlPreview"></div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="openInNewTab">
            <span class="icon">ğŸ”—</span>
            <span>åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€</span>
        </div>
        <div class="context-menu-item" id="copyUrl">
            <span class="icon">ğŸ“‹</span>
            <span>å¤åˆ¶é“¾æ¥åœ°å€</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="cancelContextMenu">
            <span class="icon">âŒ</span>
            <span>å–æ¶ˆ</span>
        </div>
    </div>

    <!-- JSON Editor JavaScript -->
    <script src="https://unpkg.com/jsoneditor@latest/dist/jsoneditor.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // UIå…ƒç´ å¼•ç”¨
            const requestsList = document.getElementById('requests-list');
            const saveBtn = document.getElementById('save-btn');
            const resetBtn = document.getElementById('reset-btn');
            const refreshBtn = document.getElementById('refresh-btn');
            const notification = document.getElementById('notification');
            const htmlModal = document.getElementById('htmlModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const modalTabs = document.getElementById('modalTabs');
            const modalTabsContent = document.getElementById('modalTabsContent');

            // Diffå¼¹å‡ºå±‚å…ƒç´ 
            const diffModal = document.getElementById('diffModal');
            const diffCloseBtn = document.getElementById('diffCloseBtn');
            const diffCancelBtn = document.getElementById('diffCancelBtn');
            const diffConfirmBtn = document.getElementById('diffConfirmBtn');
            const diffOriginal = document.getElementById('diffOriginal');
            const diffModified = document.getElementById('diffModified');
            const diffStats = document.getElementById('diffStats');

            // UIå…ƒç´ 
            const toggleResponseBtn = document.getElementById('toggle-response-btn');
            const copyResponseBtn = document.getElementById('copy-response-btn');
            const copyFromResponseBtn = document.getElementById('copy-from-response');
            const formatResponseBtn = document.getElementById('format-response-btn');
            const resetExpectBtn = document.getElementById('reset-expect-btn');
            const responsePanel = document.getElementById('response-panel');
            const expectPanel = document.getElementById('expect-panel');

            // å³é”®èœå•å…ƒç´ 
            const customContextMenu = document.getElementById('customContextMenu');
            const contextMenuUrlPreview = document.getElementById('contextMenuUrlPreview');
            const openInNewTabBtn = document.getElementById('openInNewTab');
            const copyUrlBtn = document.getElementById('copyUrl');
            const cancelContextMenuBtn = document.getElementById('cancelContextMenu');

            // å½“å‰å³é”®èœå•çš„URL
            let currentContextUrl = null;

            // JSONç¼–è¾‘å™¨å®ä¾‹
            let responseEditor = null;
            let expectEditor = null;

            // çŠ¶æ€å˜é‡
            let currentRequestId = null;
            let currentResponse = null;
            let allRequests = [];
            let taggedRequests = new Set(); // è®°å½•å·²æ ‡æ³¨çš„è¯·æ±‚
            let isResponsePanelExpanded = false; // API Responseé¢æ¿å±•å¼€çŠ¶æ€

            // åˆå§‹åŒ–JSONç¼–è¾‘å™¨
            function initializeJsonEditors() {
                // å“åº”ç¼–è¾‘å™¨ï¼ˆåªè¯»ï¼‰
                const responseContainer = document.getElementById('response-editor');
                responseEditor = new JSONEditor(responseContainer, {
                    mode: 'view',
                    modes: ['view', 'text'],
                    search: true,
                    navigationBar: false,
                    onModeChange: function (newMode, oldMode) {
                        if (newMode === 'view') {
                            setTimeout(() => {
                                responseEditor.expandAll();
                                highlightImportantFields();
                            }, 150);
                        }
                    }
                });

                // æœŸæœ›ç»“æœç¼–è¾‘å™¨ï¼ˆå¯ç¼–è¾‘ï¼‰
                const expectContainer = document.getElementById('expect-editor');
                expectEditor = new JSONEditor(expectContainer, {
                    mode: 'tree',
                    modes: ['tree', 'code', 'text'],
                    search: true,
                    onModeChange: function (newMode, oldMode) {
                        if (newMode === 'tree') {
                            setTimeout(() => {
                                expectEditor.expandAll();
                                highlightImportantFields();
                            }, 150);
                        }
                    }
                });
            }

            // æ˜¾ç¤ºé€šçŸ¥
            function showNotification(message, isError = false) {
                notification.textContent = message;
                notification.className = 'notification';
                if (isError) {
                    notification.classList.add('error');
                }
                notification.style.display = 'block';

                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }







            // å¿«æ·é”®æ”¯æŒ
            function setupKeyboardShortcuts() {
                document.addEventListener('keydown', function (e) {
                    // é˜»æ­¢åœ¨ç¼–è¾‘å™¨ä¸­è§¦å‘å¿«æ·é”®
                    if (e.target.closest('.jsoneditor')) return;

                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 's':
                                e.preventDefault();
                                if (e.shiftKey) {
                                    // Ctrl+Shift+S: å¼ºåˆ¶ä¿å­˜ï¼ˆå³ä½¿æ²¡æœ‰å·®å¼‚ï¼‰
                                    console.log('å¿«æ·é”®å¼ºåˆ¶ä¿å­˜');
                                    saveExpectation(true, true);
                                    showNotification('âš¡ å¿«æ·é”®å¼ºåˆ¶ä¿å­˜æˆåŠŸ');
                                } else {
                                    // Ctrl+S: æ­£å¸¸ä¿å­˜é€»è¾‘
                                    console.log('å¿«æ·é”®æ­£å¸¸ä¿å­˜');
                                    saveExpectation();
                                }
                                break;
                            case 'r':
                                e.preventDefault();
                                resetToResponse();
                                break;
                        }
                    } else {
                        switch (e.key) {
                            case 'Escape':
                                if (diffModal.style.display === 'block') {
                                    closeDiffModal();
                                } else if (htmlModal.style.display === 'block') {
                                    closeHtmlModal();
                                }
                                break;
                        }
                    }
                });
            }

            // ä»API Responseå¤åˆ¶åˆ°Expected Response
            function copyFromResponse() {
                if (responseEditor && expectEditor) {
                    try {
                        const responseData = responseEditor.get();
                        expectEditor.set(responseData);
                        // è®¾ç½®æ•°æ®åè‡ªåŠ¨å±•å¼€
                        setTimeout(() => {
                            expectEditor.expandAll();
                            highlightImportantFields();
                        }, 150);
                        showNotification('å·²ä»API Responseå¤åˆ¶æ•°æ®');
                    } catch (err) {
                        showNotification('å¤åˆ¶å¤±è´¥: ' + err.message, true);
                    }
                }
            }

            // é‡ç½®åˆ°API Response
            function resetToResponse() {
                if (responseEditor && expectEditor && currentResponse) {
                    try {
                        expectEditor.set(currentResponse);
                        // è®¾ç½®æ•°æ®åè‡ªåŠ¨å±•å¼€
                        setTimeout(() => {
                            expectEditor.expandAll();
                            highlightImportantFields();
                        }, 150);
                        showNotification('å·²é‡ç½®ä¸ºAPI Response');
                    } catch (err) {
                        showNotification('é‡ç½®å¤±è´¥: ' + err.message, true);
                    }
                }
            }

            // ä¿å­˜æœŸæœ›ç»“æœ
            function saveExpectation(showMessage = true, forceMarkAsTagged = false) {
                if (!currentRequestId || !expectEditor) return;

                try {
                    const expectData = expectEditor.get();

                fetch(`/api/update_expect/${currentRequestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                        body: JSON.stringify({ expect: expectData })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Failed to save');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                            // ä¿å­˜æˆåŠŸåï¼Œæ ‡è®°ä¸ºå·²æ ‡æ³¨ï¼ˆå› ä¸ºç°åœ¨å­˜åœ¨expectationæ–‡ä»¶äº†ï¼‰
                            taggedRequests.add(currentRequestId);
                            updateRequestItemStatus(currentRequestId, true);
                            console.log('ä¿å­˜æˆåŠŸï¼Œæ ‡è®°ä¸ºå·²æ ‡æ³¨ï¼ˆå­˜åœ¨expectationæ–‡ä»¶ï¼‰');

                            if (showMessage) {
                    if (data.status === 'success') {
                                    showNotification('âœ… ' + (data.message || 'æ ‡æ³¨ä¿å­˜æˆåŠŸï¼'));
                    } else {
                                    showNotification('âš ï¸ ' + (data.message || 'æœ¬åœ°ä¿å­˜æˆåŠŸï¼Œä½†S3ä¸Šä¼ å¤±è´¥'), true);
                                }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                            if (showMessage) {
                                showNotification('âŒ ä¿å­˜å¤±è´¥: ' + error.message, true);
                            }
                        });
                } catch (err) {
                    if (showMessage) {
                        showNotification('âŒ JSONæ ¼å¼é”™è¯¯: ' + err.message, true);
                    }
                }
            }

            // æ›´æ–°è¯·æ±‚é¡¹çŠ¶æ€
            function updateRequestItemStatus(requestId, isTagged) {
                const requestItem = document.querySelector(`[data-id="${requestId}"]`);
                if (requestItem) {
                    if (isTagged) {
                        requestItem.classList.add('tagged');
                    } else {
                        requestItem.classList.remove('tagged');
                    }
                }
            }

            // å¼¹å‡ºå±‚æ§åˆ¶å‡½æ•°
            function openHtmlModal(requestId, requestName) {
                modalTitle.textContent = `HTML Content - ${requestName}`;
                htmlModal.style.display = 'block';
                loadHtmlFilesForModal(requestId);
            }

            function closeHtmlModal() {
                htmlModal.style.display = 'none';
                modalTabs.innerHTML = '';
                modalTabsContent.innerHTML = '';
                // å…³é—­å¼¹å‡ºå±‚æ—¶æ¸…é™¤JSONç¼–è¾‘å™¨ä¸­çš„æœç´¢é«˜äº®
                clearJsonHighlights();
            }

            // å…³é—­å¼¹å‡ºå±‚äº‹ä»¶
            modalCloseBtn.addEventListener('click', closeHtmlModal);

            // ç‚¹å‡»å¼¹å‡ºå±‚èƒŒæ™¯å…³é—­
            htmlModal.addEventListener('click', function (e) {
                if (e.target === htmlModal) {
                    closeHtmlModal();
                }
            });

            // ESCé”®å…³é—­å¼¹å‡ºå±‚
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && htmlModal.style.display === 'block') {
                    closeHtmlModal();
                }
            });

            // ä¸ºå¼¹å‡ºå±‚åŠ è½½HTMLæ–‡ä»¶
            function loadHtmlFilesForModal(requestId) {
                modalTabs.innerHTML = '<p>Loading HTML files...</p>';
                modalTabsContent.innerHTML = '';

                fetch(`/api/html_files/${requestId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load HTML files');
                        }
                        return response.json();
                    })
                    .then(data => {
                        modalTabs.innerHTML = '';
                        modalTabsContent.innerHTML = '';

                        if (data.html_files && data.html_files.length > 0) {
                            data.html_files.forEach((file, index) => {
                                // åˆ›å»ºé€‰é¡¹å¡
                                const tab = document.createElement('div');
                                tab.className = 'modal-tab';
                                if (index === 0) tab.classList.add('active');
                                tab.textContent = file;
                                tab.addEventListener('click', function () {
                                    // åˆ‡æ¢é€‰é¡¹å¡
                                    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                                    document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));
                                    this.classList.add('active');
                                    document.getElementById(`tab-content-${index}`).classList.add('active');
                                });
                                modalTabs.appendChild(tab);

                                // åˆ›å»ºå†…å®¹åŒºåŸŸ
                                const content = document.createElement('div');
                                content.className = 'modal-tab-content';
                                content.id = `tab-content-${index}`;
                                if (index === 0) content.classList.add('active');
                                content.innerHTML = '<p>Loading HTML content...</p>';
                                modalTabsContent.appendChild(content);

                                // åŠ è½½HTMLå†…å®¹
                                fetch(`/api/html_body_file/${requestId}?file=${encodeURIComponent(file)}`)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Failed to load HTML content');
                                        }
                                        return response.text();
                                    })
                                                        .then(html => {
                        // å¤„ç†HTMLå†…å®¹ï¼Œæ·»åŠ æ–°çª—å£æ‰“å¼€å’ŒURLæç¤º
                        const processedHtml = processHtmlContent(html);
                        content.innerHTML = processedHtml;

                        // è®¾ç½®URLæ‚¬åœäº‹ä»¶ï¼ˆæ¯æ¬¡åŠ è½½æ–°å†…å®¹åéƒ½è¦é‡æ–°è®¾ç½®ï¼‰
                        setupModalUrlEvents();
                    })
                                    .catch(error => {
                                        console.error('Error loading HTML content:', error);
                                        content.innerHTML = `<p class="status-error">Error loading HTML: ${error.message}</p>`;
                                    });
                            });
                        } else {
                            modalTabs.innerHTML = '<p>No HTML files found</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading HTML files:', error);
                        modalTabs.innerHTML = `<p class="status-error">Error loading HTML files: ${error.message}</p>`;
                    });
            }

            // æ˜¾ç¤ºä¿®æ”¹å·®å¼‚å¯¹æ¯”
            function showModificationDiff(requestId) {
                console.log('æ˜¾ç¤ºä¿®æ”¹å·®å¼‚å¯¹æ¯”ï¼Œè¯·æ±‚ID:', requestId);

                // å…ˆåŠ è½½è¯·æ±‚è¯¦æƒ…
                fetch(`/api/request/${requestId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load request details');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('åŠ è½½æ•°æ®ç”¨äºdiffå¯¹æ¯”:', data);

                        // ä½¿ç”¨ç°æœ‰çš„diffåŠŸèƒ½æ˜¾ç¤ºå¯¹æ¯”
                        const originalData = data.response;
                        const modifiedData = data.expect;

                        // è®¾ç½®diffæ¨¡æ€æ¡†æ ‡é¢˜
                        const diffTitle = document.querySelector('#diffModal h3');
                        if (diffTitle) {
                            diffTitle.textContent = `ä¿®æ”¹å†…å®¹å·®å¼‚å¯¹æ¯” - ${data.name}`;
                        }

                        // ä½¿ç”¨showDiffModalæ˜¾ç¤ºå·®å¼‚å¯¹æ¯”ï¼ˆä¸æ˜¾ç¤ºç¡®è®¤æŒ‰é’®ï¼‰
                        showDiffModal(originalData, modifiedData, false);
                    })
                    .catch(error => {
                        console.error('åŠ è½½diffæ•°æ®å¤±è´¥:', error);
                        showNotification('åŠ è½½å·®å¼‚å¯¹æ¯”å¤±è´¥: ' + error.message, true);
                    });
            }

            // åˆå§‹åŒ–åº”ç”¨
            function initializeApp() {
                initializeJsonEditors();
                setupKeyboardShortcuts();
                setupEventListeners();
                setupModalUrlEvents();
                setupContextMenu();
                setupGlobalUrlClickDelegation();
                loadRequests();
            }

            // JSONå·®å¼‚å¯¹æ¯”åŠŸèƒ½
            // æ·±åº¦æ¯”è¾ƒä¸¤ä¸ªJSONå¯¹è±¡æ˜¯å¦è¯­ä¹‰ç›¸åŒ
            function deepEqual(obj1, obj2) {
                if (obj1 === obj2) {
                    return true;
                }

                if (obj1 == null || obj2 == null) {
                    return obj1 === obj2;
                }

                if (typeof obj1 !== typeof obj2) {
                    return false;
                }

                if (typeof obj1 !== 'object') {
                    return obj1 === obj2;
                }

                if (Array.isArray(obj1) !== Array.isArray(obj2)) {
                    return false;
                }

                const keys1 = Object.keys(obj1);
                const keys2 = Object.keys(obj2);

                if (keys1.length !== keys2.length) {
                    return false;
                }

                for (let key of keys1) {
                    if (!keys2.includes(key)) {
                        return false;
                    }

                    if (!deepEqual(obj1[key], obj2[key])) {
                        return false;
                    }
                }

                return true;
            }

            // æ™ºèƒ½JSONå·®å¼‚æ£€æµ‹
            function getJsonDifferences(obj1, obj2, path = '') {
                const differences = [];

                // å¤„ç†null/undefinedæƒ…å†µ
                if (obj1 === null || obj1 === undefined || obj2 === null || obj2 === undefined) {
                    if (obj1 !== obj2) {
                        differences.push({
                            path: path || 'root',
                            type: 'modified',
                            oldValue: obj1,
                            newValue: obj2
                        });
                    }
                    return differences;
                }

                // å¤„ç†åŸºç¡€ç±»å‹
                if (typeof obj1 !== 'object' || typeof obj2 !== 'object') {
                    if (obj1 !== obj2) {
                        differences.push({
                            path: path || 'root',
                            type: 'modified',
                            oldValue: obj1,
                            newValue: obj2
                        });
                    }
                    return differences;
                }

                // å¤„ç†æ•°ç»„
                if (Array.isArray(obj1) || Array.isArray(obj2)) {
                    if (Array.isArray(obj1) !== Array.isArray(obj2)) {
                        differences.push({
                            path: path || 'root',
                            type: 'modified',
                            oldValue: obj1,
                            newValue: obj2
                        });
                        return differences;
                    }

                    // ä¸¤ä¸ªéƒ½æ˜¯æ•°ç»„ï¼Œæ¯”è¾ƒé•¿åº¦å’Œå…ƒç´ 
                    const maxLength = Math.max(obj1.length, obj2.length);
                    for (let i = 0; i < maxLength; i++) {
                        const currentPath = path ? `${path}[${i}]` : `[${i}]`;
                        if (i >= obj1.length) {
                            differences.push({
                                path: currentPath,
                                type: 'added',
                                newValue: obj2[i]
                            });
                        } else if (i >= obj2.length) {
                            differences.push({
                                path: currentPath,
                                type: 'removed',
                                oldValue: obj1[i]
                            });
                        } else {
                            differences.push(...getJsonDifferences(obj1[i], obj2[i], currentPath));
                        }
                    }
                    return differences;
                }

                // å¤„ç†å¯¹è±¡
                const allKeys = new Set([...Object.keys(obj1), ...Object.keys(obj2)]);

                for (const key of allKeys) {
                    const currentPath = path ? `${path}.${key}` : key;

                    if (!(key in obj1)) {
                        // æ–°å¢å­—æ®µ
                        differences.push({
                            path: currentPath,
                            type: 'added',
                            newValue: obj2[key]
                        });
                    } else if (!(key in obj2)) {
                        // åˆ é™¤å­—æ®µ
                        differences.push({
                            path: currentPath,
                            type: 'removed',
                            oldValue: obj1[key]
                        });
                    } else {
                        // å­—æ®µå­˜åœ¨äºä¸¤ä¸ªå¯¹è±¡ä¸­ï¼Œé€’å½’æ¯”è¾ƒ
                        differences.push(...getJsonDifferences(obj1[key], obj2[key], currentPath));
                    }
                }

                return differences;
            }

            // ç”Ÿæˆæ™ºèƒ½diff HTMLæ˜¾ç¤º
            function generateSmartDiffHtml(differences, originalData, modifiedData) {
                if (differences.length === 0) {
                    return {
                        originalHtml: '<pre class="json-content">' + JSON.stringify(originalData, null, 2) + '</pre>',
                        modifiedHtml: '<pre class="json-content">' + JSON.stringify(modifiedData, null, 2) + '</pre>'
                    };
                }

                let originalHtml = '<div class="smart-diff-container">';
                let modifiedHtml = '<div class="smart-diff-container">';

                differences.forEach((diff, index) => {
                    const pathDisplay = diff.path.replace(/\./g, ' â†’ ');

                    if (diff.type === 'added') {
                        originalHtml += `<div class="diff-item unchanged">
                            <div class="diff-path">${pathDisplay}</div>
                            <div class="diff-content">-</div>
                        </div>`;

                        modifiedHtml += `<div class="diff-item added">
                            <div class="diff-path">${pathDisplay}</div>
                            <div class="diff-content">+ ${JSON.stringify(diff.newValue, null, 2)}</div>
                        </div>`;
                    } else if (diff.type === 'removed') {
                        originalHtml += `<div class="diff-item removed">
                            <div class="diff-path">${pathDisplay}</div>
                            <div class="diff-content">- ${JSON.stringify(diff.oldValue, null, 2)}</div>
                        </div>`;

                        modifiedHtml += `<div class="diff-item unchanged">
                            <div class="diff-path">${pathDisplay}</div>
                            <div class="diff-content">-</div>
                        </div>`;
                    } else if (diff.type === 'modified') {
                        originalHtml += `<div class="diff-item removed">
                            <div class="diff-path">${pathDisplay}</div>
                            <div class="diff-content">- ${JSON.stringify(diff.oldValue, null, 2)}</div>
                        </div>`;

                        modifiedHtml += `<div class="diff-item added">
                            <div class="diff-path">${pathDisplay}</div>
                            <div class="diff-content">+ ${JSON.stringify(diff.newValue, null, 2)}</div>
                        </div>`;
                    }
                });

                originalHtml += '</div>';
                modifiedHtml += '</div>';

                return { originalHtml, modifiedHtml };
            }

            function compareJSON(original, modified) {
                // é¦–å…ˆè¿›è¡Œæ·±åº¦è¯­ä¹‰æ¯”è¾ƒ
                if (deepEqual(original, modified)) {
                    return { diffs: [], count: 0 };
                }

                // ä½¿ç”¨æ™ºèƒ½JSONå·®å¼‚æ£€æµ‹
                const differences = getJsonDifferences(original, modified);

                console.log('æ™ºèƒ½diffæ£€æµ‹åˆ°çš„å·®å¼‚:', differences);

                return {
                    diffs: differences,
                    count: differences.length
                };
            }

            // é«˜äº®æ˜¾ç¤ºJSONå·®å¼‚
            function highlightDifferences(original, modified) {
                const originalLines = original.split('\n');
                const modifiedLines = modified.split('\n');
                const maxLines = Math.max(originalLines.length, modifiedLines.length);

                let originalHtml = '';
                let modifiedHtml = '';

                for (let i = 0; i < maxLines; i++) {
                    const origLine = originalLines[i] || '';
                    const modLine = modifiedLines[i] || '';

                    if (origLine === modLine) {
                        // ç›¸åŒçš„è¡Œ
                        originalHtml += escapeHtml(origLine) + '\n';
                        modifiedHtml += escapeHtml(modLine) + '\n';
                    } else {
                        // ä¸åŒçš„è¡Œ
                        if (origLine === '') {
                            // æ–°å¢è¡Œ
                            originalHtml += '\n';
                            modifiedHtml += `<span class="diff-added">${escapeHtml(modLine)}</span>\n`;
                        } else if (modLine === '') {
                            // åˆ é™¤è¡Œ
                            originalHtml += `<span class="diff-removed">${escapeHtml(origLine)}</span>\n`;
                            modifiedHtml += '\n';
                        } else {
                            // ä¿®æ”¹è¡Œ
                            originalHtml += `<span class="diff-removed">${escapeHtml(origLine)}</span>\n`;
                            modifiedHtml += `<span class="diff-added">${escapeHtml(modLine)}</span>\n`;
                        }
                    }
                }

                return { originalHtml, modifiedHtml };
            }

            // HTMLè½¬ä¹‰å‡½æ•°
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // æ˜¾ç¤ºDiffå¯¹æ¯”å¼¹å‡ºå±‚
            function showDiffModal(originalData, modifiedData, showConfirmButton = true) {
                const comparison = compareJSON(originalData, modifiedData);

                // ä½¿ç”¨æ™ºèƒ½diffæ˜¾ç¤º
                const smartDiff = generateSmartDiffHtml(comparison.diffs, originalData, modifiedData);

                // è®¾ç½®å†…å®¹
                diffOriginal.innerHTML = smartDiff.originalHtml;
                diffModified.innerHTML = smartDiff.modifiedHtml;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                let statsText = '';
                if (comparison.count === 0) {
                    statsText = 'æ— å·®å¼‚';
                } else {
                    const addedCount = comparison.diffs.filter(d => d.type === 'added').length;
                    const removedCount = comparison.diffs.filter(d => d.type === 'removed').length;
                    const modifiedCount = comparison.diffs.filter(d => d.type === 'modified').length;

                    const parts = [];
                    if (addedCount > 0) parts.push(`æ–°å¢ ${addedCount} é¡¹`);
                    if (removedCount > 0) parts.push(`åˆ é™¤ ${removedCount} é¡¹`);
                    if (modifiedCount > 0) parts.push(`ä¿®æ”¹ ${modifiedCount} é¡¹`);

                    statsText = `å…± ${comparison.count} å¤„å·®å¼‚: ${parts.join(', ')}`;
                }
                diffStats.textContent = statsText;

                // æ§åˆ¶ç¡®è®¤æŒ‰é’®çš„æ˜¾ç¤º
                const diffConfirmBtn = document.getElementById('diffConfirmBtn');
                if (diffConfirmBtn) {
                    diffConfirmBtn.style.display = showConfirmButton ? 'inline-block' : 'none';
                }

                // æ˜¾ç¤ºå¼¹å‡ºå±‚
                diffModal.style.display = 'block';

                return comparison.count > 0;
            }

            // å…³é—­Diffå¼¹å‡ºå±‚
            function closeDiffModal() {
                diffModal.style.display = 'none';
            }

            // åˆ‡æ¢API Responseé¢æ¿æ˜¾ç¤º/éšè—
            function toggleResponsePanel() {
                isResponsePanelExpanded = !isResponsePanelExpanded;

                if (isResponsePanelExpanded) {
                    responsePanel.classList.add('expanded');
                    expectPanel.classList.add('collapsed');
                    toggleResponseBtn.textContent = 'ğŸ‘ï¸ æ”¶èµ·';
                    toggleResponseBtn.classList.add('primary');
                } else {
                    responsePanel.classList.remove('expanded');
                    expectPanel.classList.remove('collapsed');
                    toggleResponseBtn.textContent = 'ğŸ‘ï¸ å±•å¼€';
                    toggleResponseBtn.classList.remove('primary');
                }
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            function setupEventListeners() {
                // åˆ·æ–°æŒ‰é’®
                refreshBtn.addEventListener('click', loadRequests);

                // å±•å¼€/æ”¶èµ·API Responseé¢æ¿
                toggleResponseBtn.addEventListener('click', toggleResponsePanel);

                // ä¿å­˜æŒ‰é’® - å…ˆæ˜¾ç¤ºdiffå¯¹æ¯”
                saveBtn.addEventListener('click', () => showSaveDiff());

                // é‡ç½®æŒ‰é’®
                resetBtn.addEventListener('click', resetToResponse);

                // é‡ç½®ä¸ºåŸå§‹æ•°æ®æŒ‰é’®
                resetExpectBtn.addEventListener('click', function() {
                    if (!currentRequestId) {
                        showNotification('è¯·å…ˆé€‰æ‹©é‚®ä»¶', true);
                        return;
                    }

                    if (confirm('ç¡®å®šè¦åˆ é™¤æ ‡æ³¨æ–‡ä»¶å¹¶æ¢å¤ä¸ºæœªæ ‡æ³¨çŠ¶æ€å—ï¼Ÿ\n\nè¿™å°†ï¼š\nâ€¢ åˆ é™¤S3ä¸­çš„expectationæ–‡ä»¶\nâ€¢ æ¢å¤ä¸ºåŸå§‹API Responseæ•°æ®\nâ€¢ æ ‡è®°ä¸ºæœªæ ‡æ³¨çŠ¶æ€')) {
                        fetch(`/api/reset_expect/${currentRequestId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                            .then(data => {
                            if (data.status === 'success') {
                                // æ›´æ–°expectEditor
                                if (expectEditor && data.expect) {
                                    expectEditor.set(data.expect);
                                    setTimeout(() => {
                                        expectEditor.expandAll();
                                        highlightImportantFields();
                                    }, 150);
                                }
                                showNotification('âœ… ' + data.message);

                                // ç§»é™¤å·²æ ‡æ³¨çŠ¶æ€
                                taggedRequests.delete(currentRequestId);
                                updateRequestItemStatus(currentRequestId, false);
                                } else {
                                showNotification('âš ï¸ ' + data.message, true);
                                }
                            })
                            .catch(error => {
                            console.error('é‡ç½®å¤±è´¥:', error);
                            showNotification('âŒ é‡ç½®å¤±è´¥: ' + error.message, true);
                            });
                    }
                });

                // å¤åˆ¶æŒ‰é’®
                copyResponseBtn.addEventListener('click', function () {
                    if (responseEditor) {
                        try {
                            const data = responseEditor.get();
                            copyToClipboard(JSON.stringify(data, null, 2));
                        } catch (err) {
                            showNotification('å¤åˆ¶å¤±è´¥: ' + err.message, true);
                        }
                    }
                });

                // ä»ä¸Šæ–¹å¤åˆ¶æŒ‰é’®
                copyFromResponseBtn.addEventListener('click', copyFromResponse);

                // æ ¼å¼åŒ–æŒ‰é’®
                formatResponseBtn.addEventListener('click', function () {
                    if (responseEditor) {
                        responseEditor.expandAll();
                        highlightImportantFields();
                        showNotification('å·²å±•å¼€æ‰€æœ‰èŠ‚ç‚¹');
                    }
                });

                // Diffå¼¹å‡ºå±‚äº‹ä»¶ç›‘å¬å™¨
                diffCloseBtn.addEventListener('click', closeDiffModal);
                diffCancelBtn.addEventListener('click', closeDiffModal);
                diffConfirmBtn.addEventListener('click', function () {
                    closeDiffModal();
                    saveExpectation(); // ç¡®è®¤åçœŸæ­£ä¿å­˜
                });

                // ç‚¹å‡»å¼¹å‡ºå±‚èƒŒæ™¯å…³é—­
                diffModal.addEventListener('click', function (e) {
                    if (e.target === diffModal) {
                        closeDiffModal();
                    }
                });
            }

            // æ˜¾ç¤ºä¿å­˜å‰çš„diffå¯¹æ¯”
            function showSaveDiff() {
                if (!currentRequestId || !expectEditor || !currentResponse) {
                    showNotification('æ— æ³•è¿›è¡Œå¯¹æ¯”ï¼Œè¯·å…ˆé€‰æ‹©é‚®ä»¶', true);
                    return;
                }

                try {
                    const modifiedData = expectEditor.get();
                    const originalData = currentResponse;

                    // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
                    console.log('=== DIFF è°ƒè¯•ä¿¡æ¯ ===');
                    console.log('åŸå§‹æ•°æ®ç±»å‹:', typeof originalData);
                    console.log('ä¿®æ”¹æ•°æ®ç±»å‹:', typeof modifiedData);
                    console.log('åŸå§‹æ•°æ®:', originalData);
                    console.log('ä¿®æ”¹æ•°æ®:', modifiedData);

                    // æ£€æŸ¥JSONå­—ç¬¦ä¸²
                    const originalStr = JSON.stringify(originalData, null, 2);
                    const modifiedStr = JSON.stringify(modifiedData, null, 2);
                    console.log('åŸå§‹JSONå­—ç¬¦ä¸²é•¿åº¦:', originalStr.length);
                    console.log('ä¿®æ”¹JSONå­—ç¬¦ä¸²é•¿åº¦:', modifiedStr.length);
                    console.log('å­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰:', originalStr === modifiedStr);

                    // æ·±åº¦æ¯”è¾ƒç»“æœ
                    const isEqual = deepEqual(originalData, modifiedData);
                    console.log('æ·±åº¦æ¯”è¾ƒç»“æœ:', isEqual);

                    // æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹ - ä½¿ç”¨æ·±åº¦è¯­ä¹‰æ¯”è¾ƒ
                    if (isEqual) {
                        // å³ä½¿æ²¡æœ‰å·®å¼‚ä¹Ÿè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦ä¿å­˜
                        const userConfirmed = confirm('ğŸ’¡ æ•°æ®æœªå‘ç”Ÿå˜åŒ–ï¼Œæ˜¯å¦ä»è¦ä¿å­˜æ ‡æ³¨ç»“æœï¼Ÿ\n\nğŸ”¸ ç‚¹å‡»"ç¡®å®š"ï¼šä¿å­˜å½“å‰ç»“æœå¹¶æ ‡è®°ä¸ºå·²æ ‡æ³¨\nğŸ”¸ ç‚¹å‡»"å–æ¶ˆ"ï¼šè·³è¿‡ä¿å­˜\n\næç¤ºï¼šä¿å­˜æ— å·®å¼‚æ•°æ®æœ‰åŠ©äºç¡®è®¤è¯¥é‚®ä»¶å·²ç»è¿‡äººå·¥å®¡æ ¸ã€‚');

                        if (userConfirmed) {
                            console.log('ç”¨æˆ·é€‰æ‹©å¼ºåˆ¶ä¿å­˜æœªä¿®æ”¹çš„æ•°æ®');
                            // ä¼ é€’ forceMarkAsTagged = true æ¥å¼ºåˆ¶æ ‡è®°ä¸ºå·²æ ‡æ³¨
                            saveExpectation(true, true);
                            showNotification('âœ… å·²ä¿å­˜æ ‡æ³¨ç»“æœï¼Œè¯¥é‚®ä»¶å·²æ ‡è®°ä¸ºå·²å®¡æ ¸');
                        } else {
                            showNotification('â¹ï¸ å·²å–æ¶ˆä¿å­˜');
                        }
                        return;
                    }

                    // å¦‚æœä»ç„¶æœ‰å·®å¼‚ï¼ŒæŸ¥æ‰¾å…·ä½“å·®å¼‚
                    console.log('å‘ç°å·®å¼‚ï¼Œå¼€å§‹æŸ¥æ‰¾å…·ä½“ä½ç½®...');
                    findSpecificDifferences(originalData, modifiedData);

                    // æ˜¾ç¤ºdiffå¯¹æ¯”
                    showDiffModal(originalData, modifiedData);

                } catch (err) {
                    showNotification('âŒ JSONæ ¼å¼é”™è¯¯ï¼Œæ— æ³•ä¿å­˜: ' + err.message, true);
                }
            }

            // æŸ¥æ‰¾å…·ä½“çš„å·®å¼‚ä½ç½®
            function findSpecificDifferences(obj1, obj2, path = '') {
                if (typeof obj1 !== typeof obj2) {
                    console.log(`ç±»å‹å·®å¼‚ ${path}:`, typeof obj1, 'vs', typeof obj2);
                    return;
                }

                if (obj1 === obj2) {
                    return;
                }

                if (typeof obj1 !== 'object' || obj1 === null || obj2 === null) {
                    console.log(`å€¼å·®å¼‚ ${path}:`, `"${obj1}"`, 'vs', `"${obj2}"`);
                    console.log(`å€¼è¯¦æƒ… ${path}:`, {
                        value1: obj1,
                        value2: obj2,
                        type1: typeof obj1,
                        type2: typeof obj2,
                        length1: typeof obj1 === 'string' ? obj1.length : 'N/A',
                        length2: typeof obj2 === 'string' ? obj2.length : 'N/A'
                    });
                    return;
                }

                if (Array.isArray(obj1) !== Array.isArray(obj2)) {
                    console.log(`æ•°ç»„/å¯¹è±¡ç±»å‹å·®å¼‚ ${path}:`, Array.isArray(obj1), 'vs', Array.isArray(obj2));
                    return;
                }

                if (Array.isArray(obj1)) {
                    if (obj1.length !== obj2.length) {
                        console.log(`æ•°ç»„é•¿åº¦å·®å¼‚ ${path}:`, obj1.length, 'vs', obj2.length);
                    }
                    const maxLen = Math.max(obj1.length, obj2.length);
                    for (let i = 0; i < maxLen; i++) {
                        const newPath = `${path}[${i}]`;
                        if (i >= obj1.length) {
                            console.log(`ç¼ºå°‘å…ƒç´  ${newPath} in obj1`);
                        } else if (i >= obj2.length) {
                            console.log(`ç¼ºå°‘å…ƒç´  ${newPath} in obj2`);
                        } else {
                            findSpecificDifferences(obj1[i], obj2[i], newPath);
                        }
                    }
                } else {
                    const keys1 = Object.keys(obj1);
                    const keys2 = Object.keys(obj2);
                    const allKeys = new Set([...keys1, ...keys2]);

                    for (let key of allKeys) {
                        const newPath = path ? `${path}.${key}` : key;
                        if (!(key in obj1)) {
                            console.log(`ç¼ºå°‘é”® ${newPath} in obj1`);
                        } else if (!(key in obj2)) {
                            console.log(`ç¼ºå°‘é”® ${newPath} in obj2`);
                        } else {
                            findSpecificDifferences(obj1[key], obj2[key], newPath);
                        }
                    }
                }
            }

            // æ›´æ–°åŠ è½½è¯·æ±‚è¯¦æƒ…çš„å‡½æ•°
            function loadRequestDetails(requestId) {
                        currentRequestId = requestId;

                        fetch(`/api/request/${requestId}`)
                            .then(response => response.json())
                            .then(data => {
                        currentResponse = data.response;

                        // ç›´æ¥æ›´æ–°JSONç¼–è¾‘å™¨ï¼Œä¸è¿‡æ»¤æ•°æ®
                        if (responseEditor) {
                            responseEditor.set(data.response);
                            // è®¾ç½®æ•°æ®åè‡ªåŠ¨å±•å¼€
                            setTimeout(() => {
                                responseEditor.expandAll();
                                highlightImportantFields();
                            }, 150);
                        }
                        if (expectEditor) {
                            expectEditor.set(data.expect);
                            // è®¾ç½®æ•°æ®åè‡ªåŠ¨å±•å¼€
                            setTimeout(() => {
                                expectEditor.expandAll();
                                highlightImportantFields();
                            }, 150);
                        }

                        // æ£€æŸ¥æ˜¯å¦å·²æ ‡æ³¨ - åŸºäºexpectationæ–‡ä»¶æ˜¯å¦å­˜åœ¨
                        if (data.has_expectation_file) {
                            taggedRequests.add(requestId);
                            updateRequestItemStatus(requestId, true);
                            console.log(`é‚®ä»¶ ${requestId} å­˜åœ¨expectationæ–‡ä»¶ï¼Œæ ‡è®°ä¸ºå·²æ ‡æ³¨`);
                        } else {
                            taggedRequests.delete(requestId);
                            updateRequestItemStatus(requestId, false);
                            console.log(`é‚®ä»¶ ${requestId} ä¸å­˜åœ¨expectationæ–‡ä»¶ï¼Œæ ‡è®°ä¸ºæœªæ ‡æ³¨`);
                        }
                            })
                            .catch(error => {
                                console.error('Error loading request details:', error);
                        showNotification('åŠ è½½è¯·æ±‚è¯¦æƒ…å¤±è´¥: ' + error.message, true);
                    });
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ˜¾è‘—å·®å¼‚ï¼ˆåˆ¤æ–­æ˜¯å¦å·²æ ‡æ³¨ï¼‰- ä½¿ç”¨æ·±åº¦è¯­ä¹‰æ¯”è¾ƒ
            function hasSignificantDifference(response, expect) {
                return !deepEqual(response, expect);
            }

            // å¤„ç†HTMLå†…å®¹ï¼Œæ·»åŠ æ–°çª—å£æ‰“å¼€å’ŒURLæç¤ºåŠŸèƒ½
            function processHtmlContent(htmlContent) {
                // åˆ›å»ºä¸´æ—¶å®¹å™¨æ¥è§£æHTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;

                // å¤„ç†æ‰€æœ‰é“¾æ¥ï¼šæ·»åŠ æ–°çª—å£æ‰“å¼€å’ŒURLæç¤º
                const links = tempDiv.querySelectorAll('a[href]');
                links.forEach(link => {
                    // æ–°çª—å£æ‰“å¼€
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener noreferrer');

                    // æ·»åŠ URLæç¤ºï¼Œæˆªæ–­è¿‡é•¿çš„URL
                    const url = link.getAttribute('href');
                    if (url && !link.getAttribute('title')) {
                        const displayUrl = url.length > 80 ? url.substring(0, 80) + '...' : url;
                        link.setAttribute('title', `ğŸ”— æ‰“å¼€é“¾æ¥: ${displayUrl}`);
                    }

                    // æ·»åŠ æ ·å¼ç±»å’Œæ‚¬åœäº‹ä»¶
                    link.classList.add('popup-link');
                    link.setAttribute('data-full-url', url);
                });

                // å¤„ç†æ‰€æœ‰å›¾ç‰‡ï¼šæ·»åŠ URLæç¤º
                const images = tempDiv.querySelectorAll('img[src]');
                images.forEach(img => {
                    const src = img.getAttribute('src');
                    if (src && !img.getAttribute('title')) {
                        const displaySrc = src.length > 80 ? src.substring(0, 80) + '...' : src;
                        img.setAttribute('title', `ğŸ–¼ï¸ å›¾ç‰‡åœ°å€: ${displaySrc}`);
                    }

                    // æ·»åŠ æ ·å¼ç±»å’Œæ‚¬åœäº‹ä»¶
                    img.classList.add('popup-image');
                    img.setAttribute('data-full-url', src);

                    // æ·»åŠ åŠ è½½é”™è¯¯å¤„ç†
                    img.onerror = function() {
                        this.style.border = '2px dashed #ccc';
                        this.style.padding = '10px';
                        this.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥: ' + src;
                    };
                });

                // å¤„ç†background-imageçš„å…ƒç´ 
                const elementsWithBg = tempDiv.querySelectorAll('*');
                elementsWithBg.forEach(element => {
                    const style = element.getAttribute('style');
                    if (style && style.includes('background-image')) {
                        // æå–background-image URL
                        const bgMatch = style.match(/background-image:\s*url\(['"]?([^'"]+)['"]?\)/);
                        if (bgMatch && bgMatch[1] && !element.getAttribute('title')) {
                            const bgUrl = bgMatch[1];
                            const displayBgUrl = bgUrl.length > 60 ? bgUrl.substring(0, 60) + '...' : bgUrl;
                            element.setAttribute('title', `ğŸ–¼ï¸ èƒŒæ™¯å›¾ç‰‡: ${displayBgUrl}`);
                            element.classList.add('popup-bg-image');
                            element.setAttribute('data-full-url', bgUrl);
                        }
                    }
                });

                return tempDiv.innerHTML;
            }

            // å³é”®èœå•åŠŸèƒ½
            function showContextMenu(x, y, url) {
                currentContextUrl = url;
                contextMenuUrlPreview.textContent = url;
                customContextMenu.style.left = x + 'px';
                customContextMenu.style.top = y + 'px';
                customContextMenu.style.display = 'block';

                // ç¡®ä¿èœå•ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç•Œ
                const rect = customContextMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    customContextMenu.style.left = (x - rect.width) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    customContextMenu.style.top = (y - rect.height) + 'px';
                }

                console.log('æ˜¾ç¤ºå³é”®èœå•ï¼ŒURL:', url);
            }

            function hideContextMenu() {
                customContextMenu.style.display = 'none';
                currentContextUrl = null;
                console.log('éšè—å³é”®èœå•');
            }

            // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(err => {
                    // å¤‡é€‰æ–¹æ¡ˆ
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            }

            // è®¾ç½®å³é”®èœå•äº‹ä»¶ç›‘å¬å™¨
            function setupContextMenu() {
                console.log('è®¾ç½®å³é”®èœå•äº‹ä»¶ç›‘å¬å™¨...');

                // å³é”®èœå•é¡¹ç‚¹å‡»äº‹ä»¶
                openInNewTabBtn.addEventListener('click', function() {
                    if (currentContextUrl) {
                        window.open(currentContextUrl, '_blank', 'noopener,noreferrer');
                        console.log('é€šè¿‡å³é”®èœå•æ‰“å¼€URL:', currentContextUrl);
                        showNotification('ğŸ”— å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€é“¾æ¥');
                    }
                    hideContextMenu();
                });

                copyUrlBtn.addEventListener('click', function() {
                    if (currentContextUrl) {
                        copyToClipboard(currentContextUrl);
                        console.log('å¤åˆ¶URL:', currentContextUrl);
                    }
                    hideContextMenu();
                });

                cancelContextMenuBtn.addEventListener('click', function() {
                    hideContextMenu();
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
                document.addEventListener('click', function(e) {
                    if (!customContextMenu.contains(e.target)) {
                        hideContextMenu();
                    }
                });

                // ESCé”®éšè—èœå•
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        hideContextMenu();
                    }
                });

                console.log('å³é”®èœå•äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
            }

            // è®¾ç½®å¼¹å‡ºå±‚çš„URLæ‚¬åœäº‹ä»¶
            function setupModalUrlEvents() {
                const modalUrlDisplay = document.getElementById('modal-url-display');
                if (!modalUrlDisplay) return;

                // ä¸ºå¼¹å‡ºå±‚å†…å®¹æ·»åŠ äº‹ä»¶å§”æ‰˜
                const modalTabsContent = document.getElementById('modalTabsContent');
                if (!modalTabsContent) return;

                modalTabsContent.addEventListener('mouseover', function(e) {
                    const target = e.target;
                    let url = null;
                    let type = '';

                    if (target.tagName === 'A' && target.getAttribute('href')) {
                        url = target.getAttribute('href');
                        type = 'ğŸ”— é“¾æ¥';
                    } else if (target.tagName === 'IMG' && target.getAttribute('src')) {
                        url = target.getAttribute('src');
                        type = 'ğŸ–¼ï¸ å›¾ç‰‡';
                    } else if (target.getAttribute('data-full-url')) {
                        url = target.getAttribute('data-full-url');
                        type = 'ğŸ–¼ï¸ èƒŒæ™¯å›¾ç‰‡';
                    }

                    if (url) {
                        modalUrlDisplay.textContent = `${type}: ${url}`;
                        modalUrlDisplay.style.color = '#007bff';
                    }
                });

                modalTabsContent.addEventListener('mouseout', function(e) {
                    modalUrlDisplay.textContent = 'ğŸ” é¼ æ ‡æ‚¬åœåœ¨é“¾æ¥æˆ–å›¾ç‰‡ä¸ŠæŸ¥çœ‹å®Œæ•´URL | ğŸ’¡ é€‰ä¸­æ–‡æœ¬è‡ªåŠ¨åœ¨JSONä¸­æœç´¢(å¿½ç•¥å¤§å°å†™) | ğŸ–±ï¸ å³é”®URLæ‰“å¼€èœå•';
                    modalUrlDisplay.style.color = '#6c757d';
                });

                // æ·»åŠ æ–‡æœ¬é€‰æ‹©ç›‘å¬å™¨
                setupTextSelectionHighlight();
            }

            // è®¾ç½®æ–‡æœ¬é€‰æ‹©é«˜äº®åŠŸèƒ½
            function setupTextSelectionHighlight() {
                const modalTabsContent = document.getElementById('modalTabsContent');
                if (!modalTabsContent) return;

                // ç›‘å¬é¼ æ ‡æŠ¬èµ·äº‹ä»¶ï¼ˆæ–‡æœ¬é€‰æ‹©å®Œæˆï¼‰
                modalTabsContent.addEventListener('mouseup', function(e) {
                    setTimeout(() => {
                        const selectedText = window.getSelection().toString().trim();
                        if (selectedText && selectedText.length > 0) {
                            console.log('é€‰ä¸­æ–‡æœ¬:', selectedText);
                            searchInJsonEditors(selectedText);
                        }
                    }, 100);
                });

                // ç›‘å¬é”®ç›˜é€‰æ‹©äº‹ä»¶
                modalTabsContent.addEventListener('keyup', function(e) {
                    setTimeout(() => {
                        const selectedText = window.getSelection().toString().trim();
                        if (selectedText && selectedText.length > 0) {
                            console.log('é”®ç›˜é€‰ä¸­æ–‡æœ¬:', selectedText);
                            searchInJsonEditors(selectedText);
                        }
                    }, 100);
                });
            }

            // åœ¨JSONç¼–è¾‘å™¨ä¸­æœç´¢å¹¶é«˜äº®æ–‡æœ¬
            function searchInJsonEditors(searchText) {
                console.log('å¼€å§‹æœç´¢æ–‡æœ¬:', searchText);

                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                clearJsonHighlights();

                let foundCount = 0;

                // æœç´¢Responseç¼–è¾‘å™¨
                if (responseEditor) {
                    foundCount += highlightTextInJsonEditor(responseEditor, searchText, 'Response');
                }

                // æœç´¢Expectç¼–è¾‘å™¨
                if (expectEditor) {
                    foundCount += highlightTextInJsonEditor(expectEditor, searchText, 'Expect');
                }

                // æ˜¾ç¤ºæœç´¢ç»“æœ
                showSearchResultToast(searchText, foundCount);

                console.log(`æœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${foundCount} ä¸ªåŒ¹é…é¡¹`);
            }

            // åœ¨ç‰¹å®šJSONç¼–è¾‘å™¨ä¸­é«˜äº®æ–‡æœ¬
            function highlightTextInJsonEditor(editor, searchText, editorName) {
                let foundCount = 0;

                try {
                    const editorContainer = editor.getEditor ? editor.getEditor().container : editor.container;
                    if (!editorContainer) {
                        console.log(`${editorName}ç¼–è¾‘å™¨å®¹å™¨æœªæ‰¾åˆ°`);
                        return 0;
                    }

                    // æœç´¢æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
                    const walker = document.createTreeWalker(
                        editorContainer,
                        NodeFilter.SHOW_TEXT,
                        null,
                        false
                    );

                    const textNodes = [];
                    let node;
                    // å¿½ç•¥å¤§å°å†™è¿›è¡Œæœç´¢
                    const searchTextLower = searchText.toLowerCase();
                    while (node = walker.nextNode()) {
                        if (node.textContent.toLowerCase().includes(searchTextLower)) {
                            textNodes.push(node);
                        }
                    }

                    console.log(`åœ¨${editorName}ç¼–è¾‘å™¨ä¸­æ‰¾åˆ° ${textNodes.length} ä¸ªåŒ…å«æ–‡æœ¬çš„èŠ‚ç‚¹`);

                    // é«˜äº®æ‰¾åˆ°çš„æ–‡æœ¬
                    textNodes.forEach(textNode => {
                        const parent = textNode.parentElement;
                        if (parent && !parent.classList.contains('json-search-highlight')) {
                            const text = textNode.textContent;
                            const regex = new RegExp(`(${escapeRegExp(searchText)})`, 'gi');

                            if (regex.test(text)) {
                                const highlightedText = text.replace(regex, '<span class="json-search-highlight">$1</span>');

                                // åˆ›å»ºæ–°çš„HTMLå†…å®¹
                                const wrapper = document.createElement('span');
                                wrapper.innerHTML = highlightedText;

                                // æ›¿æ¢åŸæ–‡æœ¬èŠ‚ç‚¹
                                parent.replaceChild(wrapper, textNode);
                                foundCount++;

                                console.log(`åœ¨${editorName}ç¼–è¾‘å™¨ä¸­é«˜äº®äº†æ–‡æœ¬:`, searchText);
                            }
                        }
                    });

                } catch (error) {
                    console.error(`åœ¨${editorName}ç¼–è¾‘å™¨ä¸­æœç´¢æ—¶å‡ºé”™:`, error);
                }

                return foundCount;
            }

            // æ¸…é™¤JSONç¼–è¾‘å™¨ä¸­çš„é«˜äº®
            function clearJsonHighlights() {
                document.querySelectorAll('.json-search-highlight').forEach(element => {
                    const parent = element.parentNode;
                    parent.replaceChild(document.createTextNode(element.textContent), element);
                    parent.normalize();
                });

                console.log('å·²æ¸…é™¤ä¹‹å‰çš„é«˜äº®');
            }

            // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // æ˜¾ç¤ºæœç´¢ç»“æœæç¤º
            function showSearchResultToast(searchText, foundCount) {
                // ç§»é™¤ä¹‹å‰çš„æç¤º
                const existingOverlay = document.querySelector('.search-toast-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }

                // åˆ›å»ºé®ç½©å±‚
                const overlay = document.createElement('div');
                overlay.className = 'search-toast-overlay';

                // åˆ›å»ºæç¤ºæ¡†
                const toast = document.createElement('div');
                toast.className = 'search-result-toast';

                if (foundCount > 0) {
                    toast.classList.add('success');
                    toast.innerHTML = `
                        <strong>âœ… æ‰¾åˆ°åŒ¹é…å†…å®¹</strong>
                        <div class="search-details">
                            æœç´¢: "${searchText}" (å¿½ç•¥å¤§å°å†™)<br>
                            æ‰¾åˆ° ${foundCount} ä¸ªåŒ¹é…é¡¹
                        </div>
                    `;
                } else {
                    toast.classList.add('error');
                    toast.innerHTML = `
                        <strong>âŒ å†…å®¹ä¸å­˜åœ¨</strong>
                        <div class="search-details">
                            æœç´¢: "${searchText}" (å¿½ç•¥å¤§å°å†™)<br>
                            æœªæ‰¾åˆ°åŒ¹é…çš„å†…å®¹
                        </div>
                    `;
                }

                // å°†æç¤ºæ¡†æ·»åŠ åˆ°é®ç½©å±‚ä¸­
                overlay.appendChild(toast);
                document.body.appendChild(overlay);

                // ç‚¹å‡»é®ç½©å±‚å…³é—­æç¤º
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        closeToastOverlay(overlay);
                    }
                });

                // ESCé”®å…³é—­æç¤º
                const escapeHandler = function(e) {
                    if (e.key === 'Escape') {
                        closeToastOverlay(overlay);
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);

                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (overlay && overlay.parentNode) {
                        closeToastOverlay(overlay);
                        document.removeEventListener('keydown', escapeHandler);
                    }
                }, 3000);

                function closeToastOverlay(overlayElement) {
                    if (overlayElement && overlayElement.parentNode) {
                        overlayElement.style.animation = 'fadeInOverlay 0.3s ease reverse';
                        setTimeout(() => {
                            if (overlayElement.parentNode) {
                                overlayElement.remove();
                            }
                        }, 300);
                    }
                }
            }

            // é«˜äº®é‡è¦å­—æ®µå¹¶è®¾ç½®URLå­—æ®µä¸ºå¯ç‚¹å‡»
            function highlightImportantFields() {
                console.log('å¼€å§‹é«˜äº®é‡è¦å­—æ®µå’Œè®¾ç½®URLç‚¹å‡»');

                const importantFields = ['shop_domain', 'admin_domain', 'order_number'];
                const urlFields = ['image_url', 'product_url'];

                setTimeout(() => {
                    // æ¸…é™¤ä¹‹å‰çš„æ ·å¼ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
                    document.querySelectorAll('.important-field').forEach(el => el.classList.remove('important-field'));
                    document.querySelectorAll('.important-value').forEach(el => el.classList.remove('important-value'));
                    document.querySelectorAll('.clickable-url').forEach(el => {
                        el.classList.remove('clickable-url');
                        el.removeAttribute('data-url');
                        el.removeAttribute('title');
                    });
                    document.querySelectorAll('.url-field').forEach(el => el.classList.remove('url-field'));

                    // é‡è¦å­—æ®µé«˜äº®ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
                    importantFields.forEach(fieldName => {
                        document.querySelectorAll('.jsoneditor-field').forEach(element => {
                            if (element.textContent?.trim() === fieldName) {
                                element.classList.add('important-field');
                                const parent = element.closest('.jsoneditor-property');
                                if (parent) {
                                    const valueElement = parent.querySelector('.jsoneditor-value');
                                    if (valueElement) valueElement.classList.add('important-value');
                                }
                            }
                        });
                    });

                    // URLå­—æ®µå¤„ç†ï¼ˆæ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†ï¼‰
                    urlFields.forEach(fieldName => {
                        document.querySelectorAll('.jsoneditor-field').forEach(element => {
                            if (element.textContent?.trim() === fieldName) {
                                element.classList.add('url-field');
                                const parent = element.closest('.jsoneditor-property');
                                if (parent) {
                                    const valueElement = parent.querySelector('.jsoneditor-value');
                                    if (valueElement) {
                                        const urlText = valueElement.textContent.trim().replace(/"/g, '');
                                        if (urlText && (urlText.startsWith('http://') || urlText.startsWith('https://'))) {
                                            // æ·»åŠ ç‚¹å‡»ç›¸å…³å±æ€§
                                            valueElement.classList.add('clickable-url');
                                            valueElement.setAttribute('data-url', urlText);
                                            valueElement.setAttribute('title', 'ç‚¹å‡»åœ¨æ–°çª—å£æ‰“å¼€');

                                            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆç¡®ä¿åªç»‘å®šä¸€æ¬¡ï¼‰
                                            valueElement.onclick = function(e) {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                window.open(urlText, '_blank', 'noopener,noreferrer');
                                            };
                                        }
                                    }
                                }
                            }
                        });
                    });
                }, 250);
            }

            // åœ¨æ–°çª—å£ä¸­æ‰“å¼€URL
            function openUrlInNewWindow(event) {
                console.log('URLç‚¹å‡»äº‹ä»¶è§¦å‘:', event.type, event.target);

                event.preventDefault();
                event.stopPropagation();

                const url = event.target.getAttribute('data-url');
                console.log('æå–åˆ°URL:', url);

                if (url) {
                    window.open(url, '_blank', 'noopener,noreferrer');
                    console.log(`åœ¨æ–°çª—å£ä¸­æ‰“å¼€URL: ${url}`);
                } else {
                    console.log('æœªæ‰¾åˆ°URLæ•°æ®');
                }
                return false;
            }

            // è®¾ç½®å…¨å±€ç‚¹å‡»äº‹ä»¶å§”æ‰˜ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
            function setupGlobalUrlClickDelegation() {
                console.log('è®¾ç½®å…¨å±€URLç‚¹å‡»å§”æ‰˜...');

                // è¶…å¼ºå…¨å±€å§”æ‰˜ - æ•è·æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
                document.addEventListener('click', function(event) {
                    console.log('å…¨å±€ç‚¹å‡»äº‹ä»¶:', event.target, event.target.className);

                    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†URLå…ƒç´ æˆ–å…¶å­å…ƒç´ 
                    let target = event.target;
                    let urlElement = null;
                    let maxDepth = 5; // æœ€å¤šå‘ä¸ŠæŸ¥æ‰¾5å±‚

                    while (target && maxDepth > 0) {
                        if (target.classList && target.classList.contains('clickable-url')) {
                            urlElement = target;
                            break;
                        }
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«URLæ•°æ®
                        if (target.getAttribute && target.getAttribute('data-url')) {
                            urlElement = target;
                            break;
                        }
                        target = target.parentElement;
                        maxDepth--;
                    }

                    if (urlElement) {
                        console.log('å…¨å±€å§”æ‰˜å‘ç°URLç‚¹å‡»:', urlElement);
                        const url = urlElement.getAttribute('data-url');
                        if (url) {
                            console.log('å…¨å±€å§”æ‰˜æ‰“å¼€URL:', url);
                            event.preventDefault();
                            event.stopPropagation();
                            event.stopImmediatePropagation();
                            window.open(url, '_blank', 'noopener,noreferrer');
                            return false;
                        }
                    }
                }, true);

                // é¢å¤–çš„mousedownå§”æ‰˜
                document.addEventListener('mousedown', function(event) {
                    if (event.button === 0) { // å·¦é”®
                        let target = event.target;
                        let maxDepth = 5;

                        while (target && maxDepth > 0) {
                            if (target.classList && target.classList.contains('clickable-url')) {
                                const url = target.getAttribute('data-url');
                                if (url) {
                                    console.log('å…¨å±€mousedownå§”æ‰˜æ‰“å¼€URL:', url);
                                    event.preventDefault();
                                    event.stopPropagation();
                                    event.stopImmediatePropagation();
                                    window.open(url, '_blank', 'noopener,noreferrer');
                                    return false;
                                }
                                break;
                            }
                            target = target.parentElement;
                            maxDepth--;
                        }
                    }
                }, true);

                // å…¨å±€å³é”®èœå•å§”æ‰˜
                document.addEventListener('contextmenu', function(event) {
                    console.log('å…¨å±€å³é”®äº‹ä»¶:', event.target);

                    let target = event.target;
                    let urlElement = null;
                    let maxDepth = 5;

                    while (target && maxDepth > 0) {
                        if (target.classList && target.classList.contains('clickable-url')) {
                            urlElement = target;
                            break;
                        }
                        if (target.getAttribute && target.getAttribute('data-url')) {
                            urlElement = target;
                            break;
                        }
                        target = target.parentElement;
                        maxDepth--;
                    }

                    if (urlElement) {
                        const url = urlElement.getAttribute('data-url');
                        if (url) {
                            console.log('å…¨å±€å³é”®å§”æ‰˜æ˜¾ç¤ºèœå•:', url);
                            event.preventDefault();
                            event.stopPropagation();
                            showContextMenu(event.pageX, event.pageY, url);
                            return false;
                        }
                    }
                }, true);

                // é’ˆå¯¹JSONç¼–è¾‘å™¨çš„ç‰¹æ®Šå§”æ‰˜
                function setupJsonEditorDelegation(editorContainer, editorName) {
                    if (!editorContainer) {
                        console.log(`${editorName}ç¼–è¾‘å™¨å®¹å™¨æœªæ‰¾åˆ°`);
                        return;
                    }

                    console.log(`ä¸º${editorName}ç¼–è¾‘å™¨è®¾ç½®ç‰¹æ®Šå§”æ‰˜`);

                    editorContainer.addEventListener('click', function(event) {
                        console.log(`${editorName}ç¼–è¾‘å™¨ç‚¹å‡»:`, event.target);

                        // æŸ¥æ‰¾URLå…ƒç´ 
                        let target = event.target;
                        let maxDepth = 10;

                        while (target && maxDepth > 0) {
                            if (target.classList && target.classList.contains('clickable-url')) {
                                const url = target.getAttribute('data-url');
                                if (url) {
                                    console.log(`${editorName}ç¼–è¾‘å™¨å§”æ‰˜æ‰“å¼€URL:`, url);
                                    event.preventDefault();
                                    event.stopPropagation();
                                    event.stopImmediatePropagation();
                                    window.open(url, '_blank', 'noopener,noreferrer');
                                    return false;
                                }
                                break;
                            }
                            target = target.parentElement;
                            maxDepth--;
                        }
                    }, true);
                }

                // ä¸ºä¸¤ä¸ªJSONç¼–è¾‘å™¨è®¾ç½®å§”æ‰˜
                setTimeout(() => {
                    setupJsonEditorDelegation(document.getElementById('response-editor'), 'Response');
                    setupJsonEditorDelegation(document.getElementById('expect-editor'), 'Expect');
                }, 500);

                console.log('å…¨å±€URLç‚¹å‡»å§”æ‰˜è®¾ç½®å®Œæˆ');
            }

            // ä¸å†è¿‡æ»¤JSONæ•°æ®ï¼Œä¿æŒåŸå§‹æ•°æ®å®Œæ•´æ€§
            function filterImageData(data) {
                // ç›´æ¥è¿”å›åŸå§‹æ•°æ®ï¼Œä¸è¿›è¡Œä»»ä½•è¿‡æ»¤
                return data;
            }

            // å¯åŠ¨åº”ç”¨
            initializeApp();

            // åŠ è½½è¯·æ±‚åˆ—è¡¨
            function loadRequests() {
                fetch('/api/requests')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Loaded requests:', data);
                        requestsList.innerHTML = '';
                        if (data.length === 0) {
                            requestsList.innerHTML = '<p>No requests found</p>';
                            allRequests = [];
                            return;
                        }
                        // å‰ç«¯å†æ¬¡ç¡®è®¤æ’åº
                        data.sort((a, b) => a.number - b.number);
                        allRequests = data;

                        data.forEach((req, index) => {
                            addRequestToList(req.id, req.name, req.number, req.has_html, req.html_count, req.has_modifications);

                            // æ ¹æ®has_expectation_fileå­—æ®µè®¾ç½®å·²æ ‡æ³¨çŠ¶æ€
                            if (req.has_expectation_file) {
                                taggedRequests.add(req.id);
                                updateRequestItemStatus(req.id, true);
                                console.log(`é‚®ä»¶ ${req.id} (${req.name}) å­˜åœ¨expectationæ–‡ä»¶ï¼Œæ ‡è®°ä¸ºå·²æ ‡æ³¨`);
                            } else {
                                taggedRequests.delete(req.id);
                                updateRequestItemStatus(req.id, false);
                                console.log(`é‚®ä»¶ ${req.id} (${req.name}) ä¸å­˜åœ¨expectationæ–‡ä»¶ï¼Œæ ‡è®°ä¸ºæœªæ ‡æ³¨`);
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error loading requests:', error);
                        requestsList.innerHTML = `<p>Error loading requests: ${error.message}</p>`;
                    });
            }

            // æ·»åŠ è¯·æ±‚åˆ°åˆ—è¡¨
            function addRequestToList(requestId, requestName, requestNumber, hasHtml, htmlCount, hasModifications = false) {
                console.log(`Adding request ${requestId}: ${requestName}, number: ${requestNumber}, hasModifications: ${hasModifications}`);

                const requestItem = document.createElement('div');
                requestItem.className = 'request-item';

                const itemContent = document.createElement('div');
                itemContent.className = 'request-item-content';
                itemContent.innerHTML = `
                    <span class="request-number">${typeof requestNumber === 'number' ? requestNumber : '#'}</span>
                    <span class="request-name">${requestName}</span>
                    ${hasHtml ? `<span class="html-count">${htmlCount} HTMLæ–‡ä»¶</span>` : ''}
                `;

                requestItem.appendChild(itemContent);

                // å¦‚æœæœ‰ä¿®æ”¹ï¼Œæ·»åŠ "æœ‰ä¿®æ”¹"æŒ‰é’®
                if (hasModifications) {
                    const modificationBtn = document.createElement('button');
                    modificationBtn.className = 'modification-btn';
                    modificationBtn.innerHTML = 'ğŸ” æœ‰ä¿®æ”¹';
                    modificationBtn.title = 'ç‚¹å‡»æŸ¥çœ‹ä¿®æ”¹å†…å®¹çš„å·®å¼‚å¯¹æ¯”';

                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¡Œç‚¹å‡»
                    modificationBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        showModificationDiff(requestId);
                    });

                    requestItem.appendChild(modificationBtn);
                }

                requestItem.dataset.id = requestId;

                // ç‚¹å‡»é‚®ä»¶é¡¹ç›´æ¥åŠ è½½æ•°æ®å¹¶æ˜¾ç¤ºHTMLå¼¹å‡ºå±‚
                requestItem.addEventListener('click', function (e) {
                    // è®¾ç½®é«˜äº®
                    document.querySelectorAll('.request-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.classList.add('active');

                    // åŠ è½½è¯·æ±‚æ•°æ®
                    loadRequestDetails(requestId);

                    // å¦‚æœæœ‰HTMLæ–‡ä»¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºå¼¹å‡ºå±‚
                    if (hasHtml) {
                        openHtmlModal(requestId, requestName);
                    }
                });

                requestsList.appendChild(requestItem);
            }


        });
    </script>
</body>

</html>